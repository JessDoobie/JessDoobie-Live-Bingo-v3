<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player Cards</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0e8ff; text-align:center; padding:14px; }
    .wrap { max-width:900px; margin:0 auto; }
    .panel { background:#fff; padding:14px; border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.12); margin:12px 0; }
    .small { font-size:13px; opacity:.8; }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center; }
    button { cursor:pointer; padding:10px 14px; border:none; border-radius:12px; font-weight:700; background:#7d4fff; color:#fff; }
    button.danger { background:#ff3b6b; }
    button.ghost { background:#ede7ff; color:#4a2bd1; }
    table { border-collapse: collapse; margin: 10px auto; }
    th { background:#7d4fff; color:white; padding:10px; font-size:18px; }
    td { border: 1px solid #333; width: 74px; height: 62px; font-size: 18px; font-weight: 800; background: #fff; cursor:pointer; user-select:none; }
    td.marked { background:#b8ffcc; }
    td.free { background:#ffe9a8; }
    .react { background:#ede7ff; color:#4a2bd1; }
    .nav { display:flex; justify-content:center; gap:10px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="panel">
      <h1>ðŸŽ« {{ player_name or "Player" }}'s Cards</h1>
      <div class="small">Player ID: <b id="pid">{{ player_id }}</b></div>

      <div style="margin-top:8px;">
        <b>Last 5 called:</b> <span id="last5">â€”</span>
      </div>

      <div class="nav" style="margin-top:12px;">
        <button id="prevBtn" class="ghost">â¬… Prev</button>
        <div><b>Card</b> <span id="cardNum">1</span> <b>of</b> <span id="cardTotal">{{ total_cards }}</span></div>
        <button id="nextBtn" class="ghost">Next âž¡</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="readyBtn">âœ… Iâ€™m Ready</button>
        <button id="bingoBtn" class="danger">ðŸš¨ CALL BINGO</button>
        <button id="reuseBtn" class="ghost">ðŸ”„ Reuse (Clear Marks)</button>
        <button id="newCardBtn" class="ghost">ðŸŽ² New Cards</button>
        <button id="shotBtn" class="ghost">ðŸ“¸ Screenshot</button>
      </div>

      <div style="margin-top:12px;">
        <b>Reactions:</b>
        <button class="react" data-emoji="ðŸ‘€">ðŸ‘€</button>
        <button class="react" data-emoji="ðŸ”¥">ðŸ”¥</button>
        <button class="react" data-emoji="ðŸ˜±">ðŸ˜±</button>
        <button class="react" data-emoji="ðŸŽ‰">ðŸŽ‰</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: Tap squares to mark/unmark. Free space is already marked.
      </div>
    </div>

    <div class="panel" id="cardWrap">
      <table id="bingoTable">
        <tr>
          <th>B</th><th>I</th><th>N</th><th>G</th><th>O</th>
        </tr>
        <!-- grid injected by JS -->
        <tbody id="gridBody"></tbody>
      </table>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const playerId = "{{ player_id }}";
    const cards = {{ cards | tojson }};
    const totalCards = cards.length;

    let currentIndex = 0; // 0-based

    function marksKeyFor(index) {
      return "bingo_marks_" + playerId + "_card_" + index;
    }

    function loadMarks(index) {
      try { return JSON.parse(localStorage.getItem(marksKeyFor(index)) || "[]"); }
      catch { return []; }
    }

    function saveMarks(index, marks) {
      localStorage.setItem(marksKeyFor(index), JSON.stringify(marks));
    }

    function keyForCell(r,c){ return `${r},${c}`; }

    function renderGrid() {
      document.getElementById("cardNum").textContent = String(currentIndex + 1);

      const grid = cards[currentIndex];
      const tbody = document.getElementById("gridBody");
      tbody.innerHTML = "";

      for (let r = 0; r < 5; r++) {
        const tr = document.createElement("tr");
        for (let c = 0; c < 5; c++) {
          const td = document.createElement("td");
          td.dataset.r = String(r);
          td.dataset.c = String(c);

          const val = grid[r][c];
          td.textContent = val;

          if (r === 2 && c === 2) {
            td.classList.add("free", "marked");
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      applyMarks();
    }

    function applyMarks() {
      const marks = new Set(loadMarks(currentIndex));
      document.querySelectorAll("#bingoTable td").forEach(td => {
        const r = td.dataset.r, c = td.dataset.c;
        if (r == null || c == null) return;

        const isFree = (r === "2" && c === "2");
        const k = keyForCell(r,c);
        if (isFree || marks.has(k)) td.classList.add("marked");
        else td.classList.remove("marked");
      });
    }

    document.getElementById("bingoTable").addEventListener("click", (e) => {
      const td = e.target.closest("td");
      if (!td) return;

      const r = td.dataset.r, c = td.dataset.c;
      if (r == null || c == null) return;
      if (r === "2" && c === "2") return; // can't unmark free

      const marks = new Set(loadMarks(currentIndex));
      const k = keyForCell(r,c);
      if (marks.has(k)) marks.delete(k); else marks.add(k);
      saveMarks(currentIndex, [...marks]);
      applyMarks();
    });

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data || {})
      });
      const payload = await res.json().catch(()=> ({}));
      return { ok: res.ok, status: res.status, data: payload };
    }

    async function refreshState() {
      const state = await (await fetch("/api/state")).json();
      document.getElementById("last5").textContent =
        (state.last5 && state.last5.length) ? state.last5.join(" Â· ") : "â€”";
    }

    // Prev/Next
    document.getElementById("prevBtn").addEventListener("click", () => {
      currentIndex = (currentIndex - 1 + totalCards) % totalCards;
      renderGrid();
    });

    document.getElementById("nextBtn").addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % totalCards;
      renderGrid();
    });

    // Ready
    let isReady = false;
    document.getElementById("readyBtn").addEventListener("click", async () => {
      isReady = !isReady;
      await postJSON("/api/ready", { player_id: playerId, ready: isReady });
      document.getElementById("readyBtn").textContent = isReady ? "âœ… Ready (tap to unready)" : "âœ… Iâ€™m Ready";
    });

    // Bingo
    document.getElementById("bingoBtn").addEventListener("click", async () => {
      if (!confirm("Call BINGO to the host?")) return;
      await postJSON("/api/bingo", { player_id: playerId });
      alert("Bingo called! ðŸŽ‰");
    });

    // Reactions
    document.querySelectorAll(".react").forEach(btn => {
      btn.addEventListener("click", async () => {
        await postJSON("/api/reaction", { emoji: btn.dataset.emoji });
      });
    });

    // Reuse = clear marks for current card
    document.getElementById("reuseBtn").addEventListener("click", () => {
      localStorage.removeItem(marksKeyFor(currentIndex));
      isReady = false;
      document.getElementById("readyBtn").textContent = "âœ… Iâ€™m Ready";
      applyMarks();
      alert("Marks cleared âœ… Reusing this card.");
    });

    // New Cards = regenerate all cards server-side, then reload page
    document.getElementById("newCardBtn").addEventListener("click", async () => {
      if (!confirm("Generate brand new card numbers for ALL your cards?")) return;

      // clear marks for all cards locally
      for (let i = 0; i < totalCards; i++) localStorage.removeItem(marksKeyFor(i));

      isReady = false;
      document.getElementById("readyBtn").textContent = "âœ… Iâ€™m Ready";
      await postJSON("/api/ready", { player_id: playerId, ready: false });

      const res = await postJSON("/api/new_card", { player_id: playerId });
      if (res.ok) window.location.reload();
      else alert("Could not generate new cards.");
    });

    // Screenshot current card
    document.getElementById("shotBtn").addEventListener("click", async () => {
      const canvas = await html2canvas(document.getElementById("cardWrap"), { backgroundColor: "#ffffff" });
      const link = document.createElement("a");
      link.download = `bingo-card-${currentIndex+1}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    renderGrid();
    refreshState();
    setInterval(refreshState, 1500);
  </script>
</body>
</html>

