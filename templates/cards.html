<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Player Card</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0e8ff; text-align:center; padding:14px; }
    .wrap { max-width:860px; margin:0 auto; }
    .panel { background:#fff; padding:14px; border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.12); margin:12px 0; }
    .small { font-size:13px; opacity:.8; }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center; }
    button { cursor:pointer; padding:10px 14px; border:none; border-radius:12px; font-weight:700; background:#7d4fff; color:#fff; }
    button.danger { background:#ff3b6b; }
    button.ghost { background:#ede7ff; color:#4a2bd1; }
    table { border-collapse: collapse; margin: 10px auto; }
    th { background:#7d4fff; color:white; padding:10px; font-size:18px; }
    td {
      border: 1px solid #333; width: 74px; height: 62px;
      font-size: 18px; font-weight: 800; background: #fff;
      cursor:pointer; user-select:none;
    }
    td.marked { background:#b8ffcc; }
    td.free { background:#ffe9a8; }
    .react { background:#ede7ff; color:#4a2bd1; }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="panel">
      <h1>Player Card</h1>
      <div class="small">Player ID: <b id="pid">{{ player_id }}</b></div>

      <div style="margin-top:8px;">
        <b>Last 5 called:</b> <span id="last5">â€”</span>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="readyBtn">âœ… Iâ€™m Ready</button>
        <button id="bingoBtn" class="danger">ðŸš¨ CALL BINGO</button>
        <button id="reuseBtn" class="ghost">ðŸ”„ Reuse (Clear Marks)</button>
        <button id="newCardBtn" class="ghost">ðŸŽ² New Card</button>
        <button id="shotBtn" class="ghost">ðŸ“¸ Screenshot</button>
      </div>

      <div style="margin-top:12px;">
        <b>Reactions:</b>
        <button class="react" data-emoji="ðŸ‘€">ðŸ‘€</button>
        <button class="react" data-emoji="ðŸ”¥">ðŸ”¥</button>
        <button class="react" data-emoji="ðŸ˜±">ðŸ˜±</button>
        <button class="react" data-emoji="ðŸŽ‰">ðŸŽ‰</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: Tap squares to mark/unmark. Free space is already marked.
      </div>
    </div>

    <div class="panel" id="cardWrap">
      <table id="bingoTable">
        <tr>
          <th>B</th><th>I</th><th>N</th><th>G</th><th>O</th>
        </tr>

        {% for r in range(5) %}
          <tr>
            {% for c in range(5) %}
              {% set val = card[r][c] %}
              <td data-r="{{r}}" data-c="{{c}}"
                  class="{% if r==2 and c==2 %}free marked{% endif %}">
                {{ val }}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table>
    </div>

  </div>

  <!-- Screenshot library -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    const playerId = "{{ player_id }}";
    const marksKey = "bingo_marks_" + playerId;

    function loadMarks() {
      try { return JSON.parse(localStorage.getItem(marksKey) || "[]"); }
      catch { return []; }
    }

    function saveMarks(marks) {
      localStorage.setItem(marksKey, JSON.stringify(marks));
    }

    function keyForCell(r,c){ return `${r},${c}`; }

    function applyMarks() {
      const marks = new Set(loadMarks());
      document.querySelectorAll("#bingoTable td").forEach(td => {
        const r = td.dataset.r, c = td.dataset.c;
        if (r == null || c == null) return;

        const k = keyForCell(r,c);
        const isFree = (r === "2" && c === "2");
        if (isFree || marks.has(k)) td.classList.add("marked");
        else td.classList.remove("marked");
      });
    }

    // Toggle marks
    document.getElementById("bingoTable").addEventListener("click", (e) => {
      const td = e.target.closest("td");
      if (!td) return;

      const r = td.dataset.r, c = td.dataset.c;
      if (r == null || c == null) return;

      // Don't allow unmarking FREE
      if (r === "2" && c === "2") return;

      const marks = new Set(loadMarks());
      const k = keyForCell(r,c);
      if (marks.has(k)) marks.delete(k); else marks.add(k);
      saveMarks([...marks]);
      applyMarks();
    });

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data || {})
      });
      const payload = await res.json().catch(()=> ({}));
      return { ok: res.ok, status: res.status, data: payload };
    }

    // Poll last 5 numbers
    async function refreshState() {
      const state = await (await fetch("/api/state")).json();
      document.getElementById("last5").textContent =
        (state.last5 && state.last5.length) ? state.last5.join(" Â· ") : "â€”";
    }

    // Ready
    let isReady = false;
    document.getElementById("readyBtn").addEventListener("click", async () => {
      isReady = !isReady;
      await postJSON("/api/ready", { player_id: playerId, ready: isReady });
      document.getElementById("readyBtn").textContent = isReady ? "âœ… Ready (tap to unready)" : "âœ… Iâ€™m Ready";
    });

    // Call bingo
    document.getElementById("bingoBtn").addEventListener("click", async () => {
      if (!confirm("Call BINGO to the host?")) return;
      await postJSON("/api/bingo", { player_id: playerId });
      alert("Bingo called! ðŸŽ‰");
    });

    // Reactions
    document.querySelectorAll(".react").forEach(btn => {
      btn.addEventListener("click", async () => {
        const emoji = btn.dataset.emoji;
        await postJSON("/api/reaction", { emoji });
      });
    });

    // Reuse = clear marks only
    document.getElementById("reuseBtn").addEventListener("click", () => {
      localStorage.removeItem(marksKey);
      isReady = false;
      document.getElementById("readyBtn").textContent = "âœ… Iâ€™m Ready";
      applyMarks();
      alert("Marks cleared âœ… Reusing same card.");
    });

    // New card = regenerate numbers but keep same URL
    document.getElementById("newCardBtn").addEventListener("click", async () => {
      if (!confirm("Generate a brand new card?")) return;

      // clear marks + unready
      localStorage.removeItem(marksKey);
      isReady = false;
      document.getElementById("readyBtn").textContent = "âœ… Iâ€™m Ready";
      await postJSON("/api/ready", { player_id: playerId, ready: false });

      // ask server to regenerate card
      const res = await postJSON("/api/new_card", { player_id: playerId });
      if (res.ok) {
        // reload page to fetch new card values
        window.location.reload();
      } else {
        alert("Could not generate a new card.");
      }
    });

    // Screenshot
    document.getElementById("shotBtn").addEventListener("click", async () => {
      const cardEl = document.getElementById("cardWrap");
      const canvas = await html2canvas(cardEl, { backgroundColor: "#ffffff" });
      const link = document.createElement("a");
      link.download = "bingo-card.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });

    applyMarks();
    refreshState();
    setInterval(refreshState, 1500);
  </script>
</body>
</html>


