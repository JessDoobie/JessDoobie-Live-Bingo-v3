<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Bingo Caller</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0e8ff; text-align:center; padding:14px; }
    .wrap { max-width:820px; margin:0 auto; }
    .card { background:#fff; padding:14px; border-radius:14px; box-shadow:0 4px 14px rgba(0,0,0,.12); margin:12px 0; }
    .big { font-size:46px; font-weight:900; background:#7d4fff; color:#fff; display:inline-block; padding:10px 22px; border-radius:16px; }
    button { cursor:pointer; padding:10px 14px; border:none; border-radius:12px; font-weight:700; background:#7d4fff; color:#fff; }
    button.danger { background:#ff3b6b; }
    select { padding:8px; border-radius:10px; border:1px solid #bbb; }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; align-items:center; }
    .feedItem { background:#ffe5ef; border:2px solid #ff8ab3; border-radius:12px; padding:10px; margin:8px auto; max-width:560px; text-align:left; }
    .muted { opacity:.75; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bingo Caller</h1>

      <div id="currentBall" class="big">â€”</div>

      <div style="margin-top:10px;">
        <b>Last 5 called:</b> <span id="last5">â€”</span>
      </div>

      <div class="muted" style="margin-top:6px;">
        Remaining balls: <span id="remaining">â€”</span>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="nextBtn">Next Ball</button>
        <button id="newGameBtn" class="danger">New Game</button>
      </div>

      <div class="row" style="margin-top:12px;">
        <span><b>Ready:</b> <span id="readyCount">0</span></span>

        <label><b>Time between calls:</b></label>
        <select id="delaySel">
          <option value="0">Manual only</option>
          <option value="5">5 sec</option>
          <option value="10">10 sec</option>
          <option value="15">15 sec</option>
          <option value="20">20 sec</option>
          <option value="30">30 sec</option>
        </select>

        <label>
          <input type="checkbox" id="autoChk" />
          Auto-call
        </label>
      </div>

      <div style="margin-top:12px;">
        <b>Reactions:</b> <span id="reactSummary">â€”</span>
      </div>

      <div class="muted" style="margin-top:10px;">
        Share player link: <b>/</b> (your main site link) â€” Host link: <b>/caller</b>
      </div>
    </div>

    <div class="card">
      <h2>ðŸš¨ Bingo Calls</h2>
      <div id="bingoFeed"></div>
    </div>
  </div>

  <script>
    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(data || {})
      });
      const payload = await res.json().catch(()=> ({}));
      return { ok: res.ok, status: res.status, data: payload };
    }

    let autoTimer = null;

    async function refresh() {
      const state = await (await fetch("/api/state")).json();

      const called = state.called || [];
      document.getElementById("currentBall").textContent = called.length ? called[called.length - 1] : "â€”";
      document.getElementById("last5").textContent = (state.last5 && state.last5.length) ? state.last5.join(" Â· ") : "â€”";
      document.getElementById("remaining").textContent = state.remaining_count ?? "â€”";
      document.getElementById("readyCount").textContent = state.ready_count ?? 0;

      const reactions = state.reactions || {};
      document.getElementById("reactSummary").textContent =
        Object.keys(reactions).length
          ? Object.entries(reactions).map(([k,v]) => `${k} x${v}`).join("  ")
          : "â€”";

      // Bingo feed
      const feed = document.getElementById("bingoFeed");
      feed.innerHTML = "";
      (state.bingo_calls || []).slice(0, 10).forEach(item => {
        const div = document.createElement("div");
        div.className = "feedItem";
        div.innerHTML = `ðŸš¨ <b>BINGO CALLED</b> at <b>${item.time}</b> <span class="muted">(player ${item.player_id})</span>`;
        feed.appendChild(div);
      });

      // Keep dropdown/checkbox in sync with server
      document.getElementById("delaySel").value = String(state.auto_delay ?? 0);
      document.getElementById("autoChk").checked = !!state.auto_enabled;
    }

    async function callNextBall() {
      // If you want to force "everyone ready", change min_ready to your expected player count.
      const min_ready = 0;

      const res = await postJSON("/api/next", { min_ready });
      if (!res.ok && res.data.reason === "not_ready") {
        alert(`Not enough players ready yet (${res.data.ready_count}).`);
      }
    }

    document.getElementById("nextBtn").addEventListener("click", callNextBall);

    document.getElementById("newGameBtn").addEventListener("click", async () => {
      if (!confirm("Start a NEW GAME? Resets called numbers, bingo calls, reactions, and readiness.")) return;
      await postJSON("/api/new_game", {});
      await refresh();
    });

    async function syncAuto() {
      const delay = parseInt(document.getElementById("delaySel").value, 10);
      const enabled = document.getElementById("autoChk").checked && delay > 0;

      await postJSON("/api/auto", { delay, enabled });

      if (autoTimer) clearInterval(autoTimer);
      autoTimer = null;

      if (enabled) {
        autoTimer = setInterval(callNextBall, delay * 1000);
      }
    }

    document.getElementById("delaySel").addEventListener("change", syncAuto);
    document.getElementById("autoChk").addEventListener("change", syncAuto);

    refresh();
    setInterval(refresh, 1200);
  </script>
</body>
</html>
